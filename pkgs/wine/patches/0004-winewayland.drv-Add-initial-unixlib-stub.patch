From d819a6f49032b1a813bd96b5572e5e14ea7b7e04 Mon Sep 17 00:00:00 2001
From: Alexandros Frantzis <alexandros.frantzis@collabora.com>
Date: Tue, 7 Jun 2022 12:17:12 +0300
Subject: [PATCH 004/170] winewayland.drv: Add initial unixlib stub.

Signed-off-by: Alexandros Frantzis <alexandros.frantzis@collabora.com>
---
 dlls/winewayland.drv/Makefile.in       |  2 +
 dlls/winewayland.drv/dllmain.c         | 13 +++++++
 dlls/winewayland.drv/unixlib.h         | 37 ++++++++++++++++++
 dlls/winewayland.drv/waylanddrv.h      | 35 +++++++++++++++++
 dlls/winewayland.drv/waylanddrv_dll.h  |  7 ++++
 dlls/winewayland.drv/waylanddrv_main.c | 52 ++++++++++++++++++++++++++
 6 files changed, 146 insertions(+)
 create mode 100644 dlls/winewayland.drv/unixlib.h
 create mode 100644 dlls/winewayland.drv/waylanddrv.h
 create mode 100644 dlls/winewayland.drv/waylanddrv_main.c

diff --git a/dlls/winewayland.drv/Makefile.in b/dlls/winewayland.drv/Makefile.in
index bd4433304ea..cd4a7f9f66c 100644
--- a/dlls/winewayland.drv/Makefile.in
+++ b/dlls/winewayland.drv/Makefile.in
@@ -1,5 +1,6 @@
 EXTRADEFS = -DWINE_NO_LONG_TYPES
 MODULE = winewayland.drv
+UNIXLIB = winewayland.so
 CFLAGS = -std=c11 -Wno-declaration-after-statement
 EXTRACFLAGS = -std=c11 -Wno-declaration-after-statement
 CPPFLAGS = -std=c11 -Wno-declaration-after-statement
@@ -7,5 +8,6 @@ EXTRACROSSCFLAGS = -std=c11 -Wno-declaration-after-statement
 
 C_SRCS = \
 	dllmain.c \
+	waylanddrv_main.c \
 
 RC_SRCS = version.rc
diff --git a/dlls/winewayland.drv/dllmain.c b/dlls/winewayland.drv/dllmain.c
index 7ab3341e61d..e7519acd17a 100644
--- a/dlls/winewayland.drv/dllmain.c
+++ b/dlls/winewayland.drv/dllmain.c
@@ -20,11 +20,24 @@
 
 #include "waylanddrv_dll.h"
 
+static unixlib_handle_t waylanddrv_handle;
+NTSTATUS (CDECL *waylanddrv_unix_call)(enum waylanddrv_unix_func func, void *params);
+
 BOOL WINAPI DllMain(HINSTANCE instance, DWORD reason, void *reserved)
 {
+    struct waylanddrv_unix_init_params init_params;
+
     if (reason != DLL_PROCESS_ATTACH) return TRUE;
 
     DisableThreadLibraryCalls(instance);
+    if (NtQueryVirtualMemory(GetCurrentProcess(), instance, MemoryWineUnixFuncs,
+                             &waylanddrv_handle, sizeof(waylanddrv_handle), NULL))
+        return FALSE;
+
+    if (__wine_unix_call(waylanddrv_handle, waylanddrv_unix_func_init, &init_params))
+        return FALSE;
+
+    waylanddrv_unix_call = init_params.unix_call;
 
     return TRUE;
 }
diff --git a/dlls/winewayland.drv/unixlib.h b/dlls/winewayland.drv/unixlib.h
new file mode 100644
index 00000000000..2e336501593
--- /dev/null
+++ b/dlls/winewayland.drv/unixlib.h
@@ -0,0 +1,37 @@
+/*
+ * Copyright 2022 Alexandros Frantzis for Collabora Ltd
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
+ */
+
+#ifndef __WINE_WAYLANDDRV_UNIXLIB_H
+#define __WINE_WAYLANDDRV_UNIXLIB_H
+
+#include <stdarg.h>
+#include "winternl.h"
+#include "wine/unixlib.h"
+
+enum waylanddrv_unix_func
+{
+    waylanddrv_unix_func_init,
+    waylanddrv_unix_func_count,
+};
+
+struct waylanddrv_unix_init_params
+{
+    NTSTATUS (CDECL *unix_call)(enum waylanddrv_unix_func func, void *params);
+};
+
+#endif /* __WINE_WAYLANDDRV_UNIXLIB_H */
diff --git a/dlls/winewayland.drv/waylanddrv.h b/dlls/winewayland.drv/waylanddrv.h
new file mode 100644
index 00000000000..4479f2b8b57
--- /dev/null
+++ b/dlls/winewayland.drv/waylanddrv.h
@@ -0,0 +1,35 @@
+/*
+ * Wayland driver
+ *
+ * Copyright 2020 Alexandros Frantzis for Collabora Ltd
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
+ */
+
+#ifndef __WINE_WAYLANDDRV_H
+#define __WINE_WAYLANDDRV_H
+
+#ifndef __WINE_CONFIG_H
+# error You must include config.h to use this header
+#endif
+
+#include <stdarg.h>
+
+#include "windef.h"
+#include "winbase.h"
+
+#include "unixlib.h"
+
+#endif /* __WINE_WAYLANDDRV_H */
diff --git a/dlls/winewayland.drv/waylanddrv_dll.h b/dlls/winewayland.drv/waylanddrv_dll.h
index 556898d44b2..366b7e80c4b 100644
--- a/dlls/winewayland.drv/waylanddrv_dll.h
+++ b/dlls/winewayland.drv/waylanddrv_dll.h
@@ -25,4 +25,11 @@
 #include "windef.h"
 #include "winbase.h"
 
+#include "unixlib.h"
+
+/* FIXME: Use __wine_unix_call instead */
+extern NTSTATUS (CDECL *waylanddrv_unix_call)(enum waylanddrv_unix_func func, void *params) DECLSPEC_HIDDEN;
+#define WAYLANDDRV_UNIX_CALL(func, params) waylanddrv_unix_call(waylanddrv_unix_func_ ## func, params)
+
+
 #endif /* __WINE_WAYLANDDRV_DLL_H */
diff --git a/dlls/winewayland.drv/waylanddrv_main.c b/dlls/winewayland.drv/waylanddrv_main.c
new file mode 100644
index 00000000000..0db1a99bc0e
--- /dev/null
+++ b/dlls/winewayland.drv/waylanddrv_main.c
@@ -0,0 +1,52 @@
+/*
+ * WAYLANDDRV initialization code
+ *
+ * Copyright 2020 Alexandre Frantzis for Collabora Ltd
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
+ */
+
+#if 0
+#pragma makedep unix
+#endif
+
+#include "config.h"
+
+#include "ntstatus.h"
+#define WIN32_NO_STATUS
+
+#include "waylanddrv.h"
+
+static NTSTATUS CDECL waylanddrv_unix_call(enum waylanddrv_unix_func func, void *params);
+
+static NTSTATUS waylanddrv_unix_init(void *arg)
+{
+    struct waylanddrv_unix_init_params *params = arg;
+    params->unix_call = waylanddrv_unix_call;
+    return 0;
+}
+
+const unixlib_entry_t __wine_unix_call_funcs[] =
+{
+    waylanddrv_unix_init,
+};
+
+C_ASSERT(ARRAYSIZE(__wine_unix_call_funcs) == waylanddrv_unix_func_count);
+
+/* FIXME: Use __wine_unix_call instead */
+static NTSTATUS CDECL waylanddrv_unix_call(enum waylanddrv_unix_func func, void *params)
+{
+    return __wine_unix_call_funcs[func](params);
+}
-- 
2.36.1

