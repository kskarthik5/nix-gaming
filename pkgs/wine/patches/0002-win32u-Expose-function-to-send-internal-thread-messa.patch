From 52aaa144c5cc6742c9883d043d17fa7a10241def Mon Sep 17 00:00:00 2001
From: Alexandros Frantzis <alexandros.frantzis@collabora.com>
Date: Wed, 23 Jun 2021 17:22:20 +0300
Subject: [PATCH 002/170] win32u: Expose function to send internal thread
 messages.

Expose a function to drivers so that they can send internal messages to
specific threads, without the need to target a specific HWND.

Signed-off-by: Alexandros Frantzis <alexandros.frantzis@collabora.com>
---
 dlls/win32u/gdiobj.c         |  1 +
 dlls/win32u/message.c        | 14 ++++++++++++++
 dlls/win32u/win32u.spec      |  3 +++
 dlls/win32u/win32u_private.h |  3 +++
 dlls/win32u/wrappers.c       |  9 +++++++++
 include/winuser.h            |  3 +++
 6 files changed, 33 insertions(+)

diff --git a/dlls/win32u/gdiobj.c b/dlls/win32u/gdiobj.c
index 121ed4bbefd..af385df050f 100644
--- a/dlls/win32u/gdiobj.c
+++ b/dlls/win32u/gdiobj.c
@@ -1261,6 +1261,7 @@ static struct unix_funcs unix_funcs =
     __wine_get_vulkan_driver,
     __wine_get_wgl_driver,
     __wine_send_input,
+    __wine_send_internal_message_timeout,
 };
 
 NTSTATUS gdi_init(void)
diff --git a/dlls/win32u/message.c b/dlls/win32u/message.c
index f5315ec5dd4..898c46aa8c2 100644
--- a/dlls/win32u/message.c
+++ b/dlls/win32u/message.c
@@ -2827,6 +2827,20 @@ static BOOL send_message_callback( HWND hwnd, UINT msg, WPARAM wparam, LPARAM lp
     return process_message( &info, NULL, ansi );
 }
 
+/***********************************************************************
+ *		     __wine_send_internal_message_timeout  (win32u.@)
+ *
+ * Same as SendMessageTimeoutW but sends the message to a specific thread
+ * without requiring a window handle. Only works for internal Wine messages.
+ */
+LRESULT CDECL __wine_send_internal_message_timeout( DWORD dest_pid, DWORD dest_tid,
+                                                    UINT msg, WPARAM wparam, LPARAM lparam,
+                                                    UINT flags, UINT timeout, PDWORD_PTR res_ptr )
+{
+    return send_internal_message_timeout( dest_pid, dest_tid, msg, wparam, lparam,
+                                          flags, timeout, res_ptr );
+}
+
 /***********************************************************************
  *           NtUserPostMessage  (win32u.@)
  */
diff --git a/dlls/win32u/win32u.spec b/dlls/win32u/win32u.spec
index 4a8d839007e..44b8324bb6a 100644
--- a/dlls/win32u/win32u.spec
+++ b/dlls/win32u/win32u.spec
@@ -1334,3 +1334,6 @@
 @ cdecl __wine_get_brush_bitmap_info(long ptr ptr ptr)
 @ cdecl __wine_get_icm_profile(long long ptr ptr)
 @ cdecl __wine_get_file_outline_text_metric(wstr ptr)
+
+# message
+@ cdecl __wine_send_internal_message_timeout(long long long long long long long ptr)
diff --git a/dlls/win32u/win32u_private.h b/dlls/win32u/win32u_private.h
index b2d16b07d8e..095a817affa 100644
--- a/dlls/win32u/win32u_private.h
+++ b/dlls/win32u/win32u_private.h
@@ -345,6 +345,9 @@ struct unix_funcs
     const struct vulkan_funcs * (CDECL *get_vulkan_driver)( UINT version );
     struct opengl_funcs * (CDECL *get_wgl_driver)( HDC hdc, UINT version );
     BOOL (CDECL *wine_send_input)( HWND hwnd, const INPUT *input, const RAWINPUT *rawinput );
+    LRESULT (CDECL *wine_send_internal_message_timeout)( DWORD dest_pid, DWORD dest_tid,
+                                                         UINT msg, WPARAM wparam, LPARAM lparam,
+                                                         UINT flags, UINT timeout, PDWORD_PTR res_ptr );
 };
 
 /* clipboard.c */
diff --git a/dlls/win32u/wrappers.c b/dlls/win32u/wrappers.c
index 05c25a006e9..b57fea14ab5 100644
--- a/dlls/win32u/wrappers.c
+++ b/dlls/win32u/wrappers.c
@@ -1486,6 +1486,15 @@ BOOL CDECL __wine_send_input( HWND hwnd, const INPUT *input, const RAWINPUT *raw
     return unix_funcs->wine_send_input( hwnd, input, rawinput );
 }
 
+LRESULT CDECL __wine_send_internal_message_timeout( DWORD dest_pid, DWORD dest_tid,
+                                                    UINT msg, WPARAM wparam, LPARAM lparam,
+                                                    UINT flags, UINT timeout, PDWORD_PTR res_ptr )
+{
+    if (!unix_funcs) return 0;
+    return unix_funcs->wine_send_internal_message_timeout( dest_pid, dest_tid, msg, wparam, lparam,
+                                                           flags, timeout, res_ptr );
+}
+
 extern void wrappers_init( unixlib_handle_t handle )
 {
     const void *args;
diff --git a/include/winuser.h b/include/winuser.h
index 4e43d6c1170..eb902904aa0 100644
--- a/include/winuser.h
+++ b/include/winuser.h
@@ -4760,6 +4760,9 @@ WORD        WINAPI SYSTEM_KillSystemTimer( WORD );
 
 #ifdef __WINESRC__
 WINUSERAPI BOOL CDECL __wine_send_input( HWND hwnd, const INPUT *input, const RAWINPUT *rawinput );
+WINUSERAPI LRESULT CDECL __wine_send_internal_message_timeout( DWORD dest_pid, DWORD dest_tid,
+                                                               UINT msg, WPARAM wparam, LPARAM lparam,
+                                                               UINT flags, UINT timeout, PDWORD_PTR res_ptr );
 
 /* Uxtheme hook functions and struct */
 
-- 
2.36.1

