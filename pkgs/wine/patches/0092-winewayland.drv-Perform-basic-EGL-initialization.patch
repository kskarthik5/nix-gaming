From bc32ea00d4588706dc8a677f1f9d1e3cb40b0a36 Mon Sep 17 00:00:00 2001
From: Alexandros Frantzis <alexandros.frantzis@collabora.com>
Date: Wed, 29 Sep 2021 14:25:46 +0300
Subject: [PATCH 092/170] winewayland.drv: Perform basic EGL initialization.

Signed-off-by: Alexandros Frantzis <alexandros.frantzis@collabora.com>
---
 dlls/winewayland.drv/opengl.c | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/dlls/winewayland.drv/opengl.c b/dlls/winewayland.drv/opengl.c
index 214971b02f7..ff784702325 100644
--- a/dlls/winewayland.drv/opengl.c
+++ b/dlls/winewayland.drv/opengl.c
@@ -50,6 +50,13 @@ WINE_DEFAULT_DEBUG_CHANNEL(waylanddrv);
 
 static void *egl_handle;
 static void *opengl_handle;
+static EGLDisplay egl_display;
+static EGLint egl_version[2];
+
+#define DECL_FUNCPTR(f) static __typeof__(f) * p_##f = NULL
+DECL_FUNCPTR(eglGetDisplay);
+DECL_FUNCPTR(eglInitialize);
+#undef DECL_FUNCPTR
 
 static BOOL egl_init(void)
 {
@@ -80,6 +87,21 @@ static BOOL egl_init(void)
         return FALSE;
     }
 
+#define LOAD_FUNCPTR(func) do { \
+        if (!(p_##func = dlsym(egl_handle, #func))) \
+        { ERR("can't find symbol %s\n", #func); return FALSE; }    \
+    } while(0)
+    LOAD_FUNCPTR(eglGetDisplay);
+    LOAD_FUNCPTR(eglInitialize);
+#undef LOAD_FUNCPTR
+
+    if (!wayland_gbm_init()) return FALSE;
+
+    egl_display = p_eglGetDisplay((EGLNativeDisplayType) process_gbm_device);
+    if (!p_eglInitialize(egl_display, &egl_version[0], &egl_version[1]))
+        return FALSE;
+    TRACE("display %p version %u.%u\n", egl_display, egl_version[0], egl_version[1]);
+
     retval = 1;
     return TRUE;
 }
-- 
2.36.1

